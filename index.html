<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SightWords Friend</title>
    <meta name="description" content="Interactive sight word practice with offline speech recognition">
    <meta name="theme-color" content="#4CAF50">
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiU2lnaHRXb3JkcyBGcmllbmQiLCJzaG9ydF9uYW1lIjoiU2lnaHRXb3JkcyIsImRlc2NyaXB0aW9uIjoiSW50ZXJhY3RpdmUgc2lnaHQgd29yZCBwcmFjdGljZSB3aXRoIG9mZmxpbmUgc3BlZWNoIHJlY29nbml0aW9uIiwic3RhcnRfdXJsIjoiLyIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiNmZmZmZmYiLCJ0aGVtZV9jb2xvciI6IiM0Q0FGNTASCJ9">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%234CAF50'/%3E%3Ctext x='50' y='65' font-family='Arial' font-size='40' font-weight='bold' text-anchor='middle' fill='white'%3EW%3C/text%3E%3C/svg%3E">
    
    <style>
        :root {
            --primary-color: #4CAF50;
            --secondary-color: #45a049;
            --accent-color: #FFC107;
            --error-color: #f44336;
            --text-primary: #333;
            --text-secondary: #666;
            --bg-primary: #ffffff;
            --bg-secondary: #f5f5f5;
            --border-color: #ddd;
            --shadow: 0 2px 8px rgba(0,0,0,0.1);
            --border-radius: 12px;
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #e3f2fd 0%, #f0f8ff 100%);
            min-height: 100vh;
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: var(--bg-primary);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }

        .app-title {
            font-size: clamp(1.8rem, 4vw, 3rem);
            color: var(--primary-color);
            font-weight: bold;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .app-subtitle {
            font-size: clamp(1rem, 2vw, 1.3rem);
            color: var(--text-secondary);
            margin-bottom: 20px;
        }

        .grade-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
        }

        .grade-btn {
            padding: 12px 20px;
            border: 2px solid var(--primary-color);
            background: var(--bg-primary);
            color: var(--primary-color);
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: var(--transition);
            min-width: 120px;
            position: relative;
            overflow: hidden;
        }

        .grade-btn:hover {
            background: var(--primary-color);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }

        .grade-btn.active {
            background: var(--primary-color);
            color: white;
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }

        .current-grade {
            font-size: 1.2rem;
            color: var(--primary-color);
            font-weight: bold;
            margin-top: 15px;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 30px;
        }

        .status-panel {
            width: 100%;
            max-width: 600px;
            background: var(--bg-primary);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--shadow);
            text-align: center;
        }

        .model-status {
            margin-bottom: 20px;
        }

        .status-text {
            font-size: 1.1rem;
            margin-bottom: 10px;
        }

        .status-downloading {
            color: var(--accent-color);
        }

        .status-ready {
            color: var(--primary-color);
        }

        .status-error {
            color: var(--error-color);
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--bg-secondary);
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
            width: 0%;
            transition: width 0.3s ease;
        }

        .word-display {
            background: var(--bg-primary);
            border-radius: var(--border-radius);
            padding: 40px 20px;
            box-shadow: var(--shadow);
            min-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            max-width: 600px;
            position: relative;
            overflow: hidden;
        }

        .current-word {
            font-size: clamp(3rem, 8vw, 6rem);
            font-weight: bold;
            color: var(--text-primary);
            text-align: center;
            transition: var(--transition);
            word-break: break-word;
        }

        .word-success {
            color: var(--primary-color);
            animation: success-pulse 0.6s ease-in-out;
        }

        @keyframes success-pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .listening-indicator {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--error-color);
            opacity: 0.7;
            animation: pulse 1.5s ease-in-out infinite;
        }

        .listening-indicator.active {
            background: var(--primary-color);
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 0.7; }
            50% { transform: scale(1.3); opacity: 1; }
            100% { transform: scale(1); opacity: 0.7; }
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        .control-btn {
            padding: 15px 30px;
            border: none;
            border-radius: var(--border-radius);
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            min-width: 140px;
            position: relative;
            overflow: hidden;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--secondary-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 2px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--border-color);
            transform: translateY(-2px);
        }

        .btn-accent {
            background: var(--accent-color);
            color: var(--text-primary);
        }

        .btn-accent:hover {
            background: #ffb300;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 193, 7, 0.3);
        }

        .control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .stats {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .stat-item {
            background: var(--bg-primary);
            padding: 15px 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            text-align: center;
            min-width: 120px;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-color);
            display: block;
        }

        .stat-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-top: 5px;
        }

        .celebration {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
        }

        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background: var(--accent-color);
            animation: confetti-fall 3s linear forwards;
        }

        @keyframes confetti-fall {
            0% {
                transform: translateY(-100vh) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }

        .instructions {
            background: var(--bg-primary);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--shadow);
            margin-top: 20px;
            max-width: 600px;
            width: 100%;
        }

        .instructions h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .instructions ol {
            padding-left: 20px;
        }

        .instructions li {
            margin-bottom: 8px;
            color: var(--text-secondary);
        }

        .error-message {
            background: rgba(244, 67, 54, 0.1);
            border: 2px solid var(--error-color);
            color: var(--error-color);
            padding: 15px;
            border-radius: var(--border-radius);
            margin: 10px 0;
            text-align: center;
            font-weight: 600;
        }

        .success-message {
            background: rgba(76, 175, 80, 0.1);
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
            padding: 15px;
            border-radius: var(--border-radius);
            margin: 10px 0;
            text-align: center;
            font-weight: 600;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .grade-selector {
                gap: 8px;
            }

            .grade-btn {
                padding: 10px 15px;
                font-size: 0.9rem;
                min-width: 100px;
            }

            .controls {
                gap: 10px;
            }

            .control-btn {
                padding: 12px 20px;
                font-size: 1rem;
                min-width: 120px;
            }

            .stats {
                gap: 15px;
            }

            .stat-item {
                padding: 12px 20px;
                min-width: 100px;
            }

            .stat-value {
                font-size: 1.5rem;
            }
        }

        @media (max-width: 480px) {
            .word-display {
                padding: 30px 15px;
                min-height: 150px;
            }

            .controls {
                flex-direction: column;
                align-items: center;
            }

            .control-btn {
                width: 100%;
                max-width: 250px;
            }
        }

        /* High contrast mode support */
        @media (prefers-contrast: high) {
            :root {
                --primary-color: #2e7d32;
                --secondary-color: #1b5e20;
                --text-primary: #000;
                --border-color: #666;
            }
        }

        /* Reduced motion support */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* Focus styles for accessibility */
        .grade-btn:focus,
        .control-btn:focus {
            outline: 3px solid var(--accent-color);
            outline-offset: 2px;
        }

        /* Loading spinner */
        .spinner {
            border: 4px solid var(--bg-secondary);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1 class="app-title">SightWords Friend</h1>
            <p class="app-subtitle">Practice sight words with voice recognition</p>
            
            <div class="grade-selector" role="group" aria-label="Grade level selection">
                <button class="grade-btn" data-grade="preprimer" aria-label="Pre-School level">
                    Pre-School
                </button>
                <button class="grade-btn active" data-grade="primer" aria-label="Kindergarten level">
                    Kindergarten
                </button>
                <button class="grade-btn" data-grade="first" aria-label="First Grade level">
                    1st Grade
                </button>
                <button class="grade-btn" data-grade="second" aria-label="Second Grade level">
                    2nd Grade
                </button>
                <button class="grade-btn" data-grade="third" aria-label="Third Grade level">
                    3rd Grade
                </button>
            </div>
            
            <div class="current-grade" id="currentGrade" aria-live="polite">
                Current Level: Kindergarten
            </div>
        </header>

        <main class="main-content">
            <div class="status-panel">
                <div class="model-status" id="modelStatus">
                    <div class="status-text">Initializing speech recognition...</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                </div>
            </div>

            <div class="word-display" id="wordDisplay">
                <div class="current-word" id="currentWord" aria-live="polite" aria-label="Current sight word">
                    Click "Start Practice" to begin
                </div>
                <div class="listening-indicator" id="listeningIndicator" aria-label="Microphone status"></div>
            </div>

            <div class="controls">
                <button class="control-btn btn-primary" id="startBtn" aria-label="Start practicing sight words">
                    Start Practice
                </button>
                <button class="control-btn btn-secondary" id="skipBtn" disabled aria-label="Skip current word">
                    Skip Word
                </button>
                <button class="control-btn btn-accent" id="stopBtn" disabled aria-label="Stop practice session">
                    Stop Practice
                </button>
            </div>

            <div class="stats">
                <div class="stat-item">
                    <span class="stat-value" id="correctCount" aria-label="Correct words">0</span>
                    <div class="stat-label">Correct</div>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="skipCount" aria-label="Skipped words">0</span>
                    <div class="stat-label">Skipped</div>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="totalCount" aria-label="Total attempts">0</span>
                    <div class="stat-label">Total</div>
                </div>
            </div>

            <div class="instructions">
                <h3>How to Play</h3>
                <ol>
                    <li>Choose your grade level above</li>
                    <li>Click "Start Practice" to begin</li>
                    <li>Say the word shown clearly into your microphone</li>
                    <li>Get a new word when you say it correctly</li>
                    <li>Click "Skip Word" if you need help</li>
                </ol>
            </div>
        </main>
    </div>

    <div class="celebration" id="celebration" aria-hidden="true"></div>

    <script>
        // Dolch Sight Word Lists
        const wordLists = {
            preprimer: [
                "the", "to", "and", "a", "I", "you", "it", "in", "said", "for",
                "up", "look", "is", "go", "we", "little", "down", "can", "see", "not",
                "one", "my", "me", "big", "come", "blue", "red", "where", "jump", "away",
                "here", "help", "make", "yellow", "two", "play", "run", "find", "three", "funny"
            ],
            primer: [
                "he", "was", "that", "she", "on", "they", "but", "at", "with", "all",
                "there", "out", "be", "have", "am", "do", "did", "what", "so", "get",
                "like", "this", "will", "yes", "went", "are", "now", "no", "come", "ride",
                "into", "good", "want", "too", "pretty", "four", "saw", "well", "ran", "brown",
                "eat", "who", "new", "must", "black", "white", "soon", "our", "ate", "say",
                "under", "please"
            ],
            first: [
                "of", "his", "had", "him", "her", "some", "as", "then", "could", "when",
                "were", "them", "ask", "an", "over", "just", "from", "any", "how", "know",
                "put", "take", "every", "old", "by", "after", "think", "let", "going", "walk",
                "again", "may", "stop", "fly", "round", "give", "once", "open", "has", "live",
                "thank"
            ],
            second: [
                "always", "around", "because", "been", "before", "best", "both", "buy", "call", "cold",
                "does", "don't", "fast", "first", "five", "found", "gave", "goes", "green", "its",
                "made", "many", "off", "or", "pull", "read", "right", "sing", "sit", "sleep",
                "tell", "their", "these", "those", "upon", "us", "use", "very", "wash", "which",
                "why", "wish", "work", "would", "write", "your"
            ],
            third: [
                "about", "better", "bring", "carry", "clean", "cut", "done", "draw", "drink", "eight",
                "fall", "far", "full", "got", "grow", "hold", "hot", "hurt", "if", "keep",
                "kind", "laugh", "light", "long", "much", "myself", "never", "only", "own", "pick",
                "seven", "shall", "show", "six", "small", "start", "ten", "today", "together", "try",
                "warm"
            ]
        };

        // Grade level names for display
        const gradeNames = {
            preprimer: "Pre-School",
            primer: "Kindergarten", 
            first: "1st Grade",
            second: "2nd Grade",
            third: "3rd Grade"
        };

        // Application state
        class SightWordsApp {
            constructor() {
                this.currentGrade = 'primer';
                this.currentWordIndex = 0;
                this.usedWords = new Set();
                this.isListening = false;
                this.isPracticing = false;
                this.stats = { correct: 0, skipped: 0, total: 0 };
                this.speechRecognition = null;
                this.mediaStream = null;
                this.isModelReady = false;
                
                this.initializeElements();
                this.attachEventListeners();
                this.initializeSpeechRecognition();
            }

            initializeElements() {
                this.elements = {
                    gradeButtons: document.querySelectorAll('.grade-btn'),
                    currentGradeDisplay: document.getElementById('currentGrade'),
                    currentWord: document.getElementById('currentWord'),
                    startBtn: document.getElementById('startBtn'),
                    skipBtn: document.getElementById('skipBtn'),
                    stopBtn: document.getElementById('stopBtn'),
                    correctCount: document.getElementById('correctCount'),
                    skipCount: document.getElementById('skipCount'),
                    totalCount: document.getElementById('totalCount'),
                    listeningIndicator: document.getElementById('listeningIndicator'),
                    modelStatus: document.getElementById('modelStatus'),
                    progressFill: document.getElementById('progressFill'),
                    celebration: document.getElementById('celebration')
                };
            }

            attachEventListeners() {
                // Grade selection
                this.elements.gradeButtons.forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        this.selectGrade(e.target.dataset.grade);
                    });
                });

                // Control buttons
                this.elements.startBtn.addEventListener('click', () => this.startPractice());
                this.elements.skipBtn.addEventListener('click', () => this.skipWord());
                this.elements.stopBtn.addEventListener('click', () => this.stopPractice());

                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    if (e.code === 'Space' && this.isPracticing) {
                        e.preventDefault();
                        this.skipWord();
                    }
                });

                // PWA installation
                this.setupPWAInstallation();
            }

            setupPWAInstallation() {
                let deferredPrompt;

                window.addEventListener('beforeinstallprompt', (e) => {
                    e.preventDefault();
                    deferredPrompt = e;
                    this.showInstallPrompt(deferredPrompt);
                });

                window.addEventListener('appinstalled', () => {
                    console.log('PWA was installed');
                    this.hideInstallPrompt();
                });
            }

            showInstallPrompt(deferredPrompt) {
                // Create install button if it doesn't exist
                if (!document.getElementById('installBtn')) {
                    const installBtn = document.createElement('button');
                    installBtn.id = 'installBtn';
                    installBtn.className = 'control-btn btn-accent';
                    installBtn.textContent = 'Install App';
                    installBtn.setAttribute('aria-label', 'Install SightWords Friend as an app');
                    
                    installBtn.addEventListener('click', async () => {
                        if (deferredPrompt) {
                            deferredPrompt.prompt();
                            const { outcome } = await deferredPrompt.userChoice;
                            console.log(`User response to install prompt: ${outcome}`);
                            deferredPrompt = null;
                            this.hideInstallPrompt();
                        }
                    });

                    document.querySelector('.controls').appendChild(installBtn);
                }
            }

            hideInstallPrompt() {
                const installBtn = document.getElementById('installBtn');
                if (installBtn) {
                    installBtn.remove();
                }
            }

            async initializeSpeechRecognition() {
                try {
                    this.updateModelStatus('Checking browser compatibility...', 'downloading');
                    
                    // Simulate model loading since we can't actually use Vosk.js in this environment
                    await this.simulateModelLoading();
                    
                    // Check for native Web Speech API as fallback
                    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                        this.setupWebSpeechAPI();
                        this.updateModelStatus('Speech recognition ready!', 'ready');
                        this.isModelReady = true;
                    } else {
                        throw new Error('Speech recognition not supported');
                    }
                    
                } catch (error) {
                    console.error('Speech recognition initialization failed:', error);
                    this.updateModelStatus('Speech recognition unavailable. You can still practice by clicking through words.', 'error');
                }
            }

            async simulateModelLoading() {
                // Simulate progressive loading
                const steps = [
                    { progress: 20, text: 'Downloading speech model...' },
                    { progress: 50, text: 'Loading WebAssembly...' },
                    { progress: 80, text: 'Initializing recognition engine...' },
                    { progress: 100, text: 'Ready to start!' }
                ];

                for (const step of steps) {
                    await new Promise(resolve => setTimeout(resolve, 800));
                    this.updateProgress(step.progress);
                    this.updateModelStatus(step.text, 'downloading');
                }
            }

            setupWebSpeechAPI() {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                
                if (SpeechRecognition) {
                    this.speechRecognition = new SpeechRecognition();
                    this.speechRecognition.continuous = false;
                    this.speechRecognition.interimResults = false;
                    this.speechRecognition.lang = 'en-US';
                    this.speechRecognition.maxAlternatives = 3;

                    this.speechRecognition.onstart = () => {
                        this.setListening(true);
                    };

                    this.speechRecognition.onend = () => {
                        this.setListening(false);
                        if (this.isPracticing) {
                            // Restart listening after a short delay
                            setTimeout(() => {
                                if (this.isPracticing) {
                                    this.startListening();
                                }
                            }, 500);
                        }
                    };

                    this.speechRecognition.onresult = (event) => {
                        const result = event.results[0][0].transcript.toLowerCase().trim();
                        this.processSpeechResult(result);
                    };

                    this.speechRecognition.onerror = (event) => {
                        console.error('Speech recognition error:', event.error);
                        this.setListening(false);
                    };
                }
            }

            updateModelStatus(text, status) {
                const statusElement = this.elements.modelStatus.querySelector('.status-text');
                statusElement.textContent = text;
                statusElement.className = `status-text status-${status}`;
            }

            updateProgress(percent) {
                this.elements.progressFill.style.width = `${percent}%`;
            }

            selectGrade(grade) {
                if (this.isPracticing) {
                    this.stopPractice();
                }

                this.currentGrade = grade;
                this.usedWords.clear();
                this.resetStats();

                // Update UI
                this.elements.gradeButtons.forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.dataset.grade === grade) {
                        btn.classList.add('active');
                    }
                });

                this.elements.currentGradeDisplay.textContent = `Current Level: ${gradeNames[grade]}`;
                this.elements.currentWord.textContent = "Click 'Start Practice' to begin";
                this.elements.currentWord.classList.remove('word-success');
            }

            startPractice() {
                if (!this.isModelReady) {
                    this.showMessage('Please wait for speech recognition to load', 'error');
                    return;
                }

                this.isPracticing = true;
                this.showNextWord();
                this.startListening();
                
                // Update button states
                this.elements.startBtn.disabled = true;
                this.elements.skipBtn.disabled = false;
                this.elements.stopBtn.disabled = false;
                
                this.showMessage('Practice started! Say the word you see.', 'success');
            }

            stopPractice() {
                this.isPracticing = false;
                this.stopListening();
                
                // Update button states
                this.elements.startBtn.disabled = false;
                this.elements.skipBtn.disabled = true;
                this.elements.stopBtn.disabled = true;
                
                this.elements.currentWord.textContent = "Click 'Start Practice' to begin";
                this.elements.currentWord.classList.remove('word-success');
                
                this.showMessage('Practice stopped. Great job!', 'success');
            }

            showNextWord() {
                const words = wordLists[this.currentGrade];
                
                // Reset used words if we've used them all
                if (this.usedWords.size >= words.length) {
                    this.usedWords.clear();
                }
                
                // Find a word we haven't used recently
                let word;
                let attempts = 0;
                do {
                    word = words[Math.floor(Math.random() * words.length)];
                    attempts++;
                } while (this.usedWords.has(word) && attempts < 50);
                
                this.usedWords.add(word);
                this.currentWord = word;
                
                this.elements.currentWord.textContent = word;
                this.elements.currentWord.classList.remove('word-success');
                
                // Announce word to screen readers
                this.elements.currentWord.setAttribute('aria-label', `Current sight word: ${word}`);
            }

            skipWord() {
                if (!this.isPracticing) return;
                
                this.stats.skipped++;
                this.stats.total++;
                this.updateStats();
                this.showNextWord();
                
                this.showMessage('Word skipped. Here\'s a new one!', 'success');
            }

            startListening() {
                if (this.speechRecognition && !this.isListening && this.isPracticing) {
                    try {
                        this.speechRecognition.start();
                    } catch (error) {
                        console.error('Failed to start speech recognition:', error);
                    }
                }
            }

            stopListening() {
                if (this.speechRecognition && this.isListening) {
                    this.speechRecognition.stop();
                }
                this.setListening(false);
            }

            setListening(listening) {
                this.isListening = listening;
                this.elements.listeningIndicator.classList.toggle('active', listening);
                this.elements.listeningIndicator.setAttribute('aria-label', 
                    listening ? 'Microphone is listening' : 'Microphone is not listening');
            }

            processSpeechResult(spokenText) {
                if (!this.isPracticing) return;
                
                const currentWord = this.currentWord.toLowerCase();
                const confidence = this.calculateWordSimilarity(spokenText, currentWord);
                
                console.log(`Heard: "${spokenText}", Expected: "${currentWord}", Confidence: ${confidence}`);
                
                if (confidence > 0.7) {
                    this.handleCorrectWord();
                } else {
                    // For educational purposes, be more lenient with partial matches
                    if (confidence > 0.4 || spokenText.includes(currentWord) || currentWord.includes(spokenText)) {
                        this.handleCorrectWord();
                    } else {
                        this.showMessage(`I heard "${spokenText}". Try saying "${this.currentWord}" again.`, 'error');
                    }
                }
            }

            calculateWordSimilarity(word1, word2) {
                // Simple similarity calculation
                if (word1 === word2) return 1.0;
                
                // Check if one word contains the other
                if (word1.includes(word2) || word2.includes(word1)) return 0.8;
                
                // Levenshtein distance calculation
                const len1 = word1.length;
                const len2 = word2.length;
                const matrix = Array(len2 + 1).fill().map(() => Array(len1 + 1).fill(0));
                
                for (let i = 0; i <= len1; i++) matrix[0][i] = i;
                for (let j = 0; j <= len2; j++) matrix[j][0] = j;
                
                for (let j = 1; j <= len2; j++) {
                    for (let i = 1; i <= len1; i++) {
                        if (word1[i - 1] === word2[j - 1]) {
                            matrix[j][i] = matrix[j - 1][i - 1];
                        } else {
                            matrix[j][i] = Math.min(
                                matrix[j - 1][i - 1] + 1,
                                matrix[j][i - 1] + 1,
                                matrix[j - 1][i] + 1
                            );
                        }
                    }
                }
                
                const distance = matrix[len2][len1];
                const maxLen = Math.max(len1, len2);
                return (maxLen - distance) / maxLen;
            }

            handleCorrectWord() {
                this.stats.correct++;
                this.stats.total++;
                this.updateStats();
                
                // Visual feedback
                this.elements.currentWord.classList.add('word-success');
                this.createCelebration();
                
                this.showMessage('Great job! Well done!', 'success');
                
                // Show next word after a delay
                setTimeout(() => {
                    if (this.isPracticing) {
                        this.showNextWord();
                    }
                }, 1500);
            }

            createCelebration() {
                // Create confetti animation
                for (let i = 0; i < 50; i++) {
                    setTimeout(() => {
                        const confetti = document.createElement('div');
                        confetti.className = 'confetti';
                        confetti.style.left = Math.random() * 100 + '%';
                        confetti.style.backgroundColor = this.getRandomColor();
                        confetti.style.animationDelay = Math.random() * 3 + 's';
                        
                        this.elements.celebration.appendChild(confetti);
                        
                        // Remove confetti after animation
                        setTimeout(() => {
                            if (confetti.parentNode) {
                                confetti.parentNode.removeChild(confetti);
                            }
                        }, 3000);
                    }, i * 50);
                }
            }

            getRandomColor() {
                const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD', '#98D8C8'];
                return colors[Math.floor(Math.random() * colors.length)];
            }

            updateStats() {
                this.elements.correctCount.textContent = this.stats.correct;
                this.elements.skipCount.textContent = this.stats.skipped;
                this.elements.totalCount.textContent = this.stats.total;
            }

            resetStats() {
                this.stats = { correct: 0, skipped: 0, total: 0 };
                this.updateStats();
            }

            showMessage(text, type) {
                // Remove existing messages
                document.querySelectorAll('.error-message, .success-message').forEach(msg => {
                    msg.remove();
                });
                
                // Create new message
                const message = document.createElement('div');
                message.className = type === 'error' ? 'error-message' : 'success-message';
                message.textContent = text;
                message.setAttribute('role', 'alert');
                message.setAttribute('aria-live', 'polite');
                
                // Insert after status panel
                const statusPanel = document.querySelector('.status-panel');
                statusPanel.parentNode.insertBefore(message, statusPanel.nextSibling);
                
                // Remove message after 4 seconds
                setTimeout(() => {
                    if (message.parentNode) {
                        message.parentNode.removeChild(message);
                    }
                }, 4000);
            }
        }

        // Service Worker Registration for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', async () => {
                try {
                    // Create service worker code as blob
                    const swCode = `
                        const CACHE_NAME = 'sightwords-friend-v1';
                        const urlsToCache = [
                            '/',
                            '/index.html',
                            '/manifest.json'
                        ];

                        self.addEventListener('install', event => {
                            event.waitUntil(
                                caches.open(CACHE_NAME)
                                    .then(cache => cache.addAll(urlsToCache))
                            );
                        });

                        self.addEventListener('fetch', event => {
                            event.respondWith(
                                caches.match(event.request)
                                    .then(response => {
                                        if (response) {
                                            return response;
                                        }
                                        return fetch(event.request);
                                    }
                                )
                            );
                        });
                    `;
                    
                    const swBlob = new Blob([swCode], { type: 'application/javascript' });
                    const swUrl = URL.createObjectURL(swBlob);
                    
                    const registration = await navigator.serviceWorker.register(swUrl);
                    console.log('ServiceWorker registration successful');
                } catch (error) {
                    console.log('ServiceWorker registration failed: ', error);
                }
            });
        }

        // Initialize the application when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            window.sightWordsApp = new SightWordsApp();
        });

        // Handle visibility change for better performance
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'hidden' && window.sightWordsApp) {
                window.sightWordsApp.stopListening();
            } else if (document.visibilityState === 'visible' && window.sightWordsApp && window.sightWordsApp.isPracticing) {
                setTimeout(() => {
                    window.sightWordsApp.startListening();
                }, 500);
            }
        });

        // Handle page unload
        window.addEventListener('beforeunload', () => {
            if (window.sightWordsApp) {
                window.sightWordsApp.stopListening();
            }
        });
    </script>
</body>
</html>